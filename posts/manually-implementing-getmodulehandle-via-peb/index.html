<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Understanding the mechanishm of GetModuleHandle from Scratch via PEB from a shellcoders perspective" /><meta name="author" content="Arinjoy" /><meta property="og:locale" content="en" /><meta name="description" content="Windows Internals: From TEB to GetModuleHandle - A Practical Guide" /><meta property="og:description" content="Windows Internals: From TEB to GetModuleHandle - A Practical Guide" /><link rel="canonical" href="https://s4vtrx.github.io//posts/manually-implementing-getmodulehandle-via-peb/" /><meta property="og:url" content="https://s4vtrx.github.io//posts/manually-implementing-getmodulehandle-via-peb/" /><meta property="og:site_name" content="OffSecEchoes" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-04-24T14:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Understanding the mechanishm of GetModuleHandle from Scratch via PEB from a shellcoders perspective" /><meta name="twitter:site" content="@Arinjoy20" /><meta name="twitter:creator" content="@Arinjoy20" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Arinjoy","url":"https://www.linkedin.com/in/arinjoy-m-973668126/"},"dateModified":"2025-04-24T14:00:00+05:30","datePublished":"2025-04-24T14:00:00+05:30","description":"Windows Internals: From TEB to GetModuleHandle - A Practical Guide","headline":"Understanding the mechanishm of GetModuleHandle from Scratch via PEB from a shellcoders perspective","mainEntityOfPage":{"@type":"WebPage","@id":"https://s4vtrx.github.io//posts/manually-implementing-getmodulehandle-via-peb/"},"url":"https://s4vtrx.github.io//posts/manually-implementing-getmodulehandle-via-peb/"}</script><title>Understanding the mechanishm of GetModuleHandle from Scratch via PEB from a shellcoders perspective | OffSecEchoes</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="OffSecEchoes"><meta name="application-name" content="OffSecEchoes"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://avatars.githubusercontent.com/u/92751372?s=400&u=9754d708a4040345ede2665a4bff31e74837224e&v=4" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">OffSecEchoes</a><p class="site-subtitle fst-italic mb-0">Unleashing Cyber Arsenal: Insights from the Frontlines of Digital Warfare</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/S4vTrX" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Arinjoy20" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['arinjoy.manna','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Understanding the mechanishm of GetModuleHandle from Scratch via PEB from a shellcoders perspective</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Understanding the mechanishm of GetModuleHandle from Scratch via PEB from a shellcoders perspective</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1745483400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 24, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/arinjoy-m-973668126/">Arinjoy</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2201 words" > <em>12 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Understanding the mechanishm of GetModuleHandle from Scratch via PEB from a shellcoders perspective</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Understanding the mechanishm of GetModuleHandle from Scratch via PEB from a shellcoders perspective</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h1 id="windows-internals-from-teb-to-getmodulehandle---a-practical-guide">Windows Internals: From TEB to GetModuleHandle - A Practical Guide</h1><h2 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In the world of Windows internals and offensive security, few skills are as fundamental—yet as poorly understood—as manual DLL resolution. While most developers casually call <code class="language-plaintext highlighter-rouge">GetModuleHandle()</code> without a second thought, understanding what happens beneath this simple API call reveals a fascinating journey through process memory structures and Windows internals.</p><p><strong>Why should you care? Because when you’re writing:</strong></p><ul><li>Shellcode that needs to be position-independent<li>Anti-analysis techniques for evasion<li>Custom loaders or injection mechanisms<li>Debugging complex process issues</ul><p><strong>This guide will take you on a hands-on tour through:</strong></p><ol><li>The Thread Environment Block (TEB) - your thread’s ID card<li>The Process Environment Block (PEB) - the process’s memory diary<li>The loader’s module lists - Windows’ address book for loaded DLLs<li>Practical implementation of your own <code class="language-plaintext highlighter-rouge">GetModuleHandle</code></ol><p><strong>We’ll be using:</strong></p><ul><li>WinDbg to explore live memory structures<li>C code that works on both x86 and x64 architectures<li>Practical examples you can test immediately</ul><p>By the end, you’ll not only understand how Windows manages loaded modules, but you’ll be able to locate them without any API calls—a crucial skill for low-level programming and security research.</p><blockquote><p><strong>Fun Fact</strong>: The technique we’ll explore is used by:</p><ul><li>Malware to evade API monitoring<li>Game cheats to bypass detection<li>Security tools to analyze processes without hooks<li>Debuggers to understand module loading</ul></blockquote><p>Let’s begin our journey at the very foundation—the Thread Environment Block.</p><h2 id="accessing-the-thread-environment-block-teb"><span class="me-2"><strong>Accessing the Thread Environment Block (TEB)</strong></span><a href="#accessing-the-thread-environment-block-teb" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The Thread Environment Block (TEB) is a fundamental Windows data structure that stores critical thread-specific information. Each thread in a process has its own TEB, which contains essential execution context including the thread’s stack boundaries (base and limit addresses), Thread-Local Storage (TLS) slots for thread-specific data, and the Structured Exception Handling (SEH) chain for error management. The TEB also holds important references like a pointer to the <strong>Process Environment Block (PEB)</strong> which we will explore in detail further below. Additionally, it maintains the thread’s LastError value, hardware breakpoint registers for debugging, and various system pointers that help manage thread execution and synchronization. This structure is crucial for low-level operations, debugging, and security analysis, as it provides direct access to a thread’s execution environment without relying on higher-level APIs</p><h3 id="accessing-the-teb-pointer-programtically"><span class="me-2">Accessing the TEB Pointer programtically</span><a href="#accessing-the-teb-pointer-programtically" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// Accessing the TEB pointer:</span>
<span class="n">x86</span><span class="o">:</span> <span class="n">TEB</span><span class="o">*</span> <span class="n">threadEnvBlock</span> <span class="o">=</span> <span class="p">(</span><span class="n">TEB</span><span class="o">*</span><span class="p">)</span><span class="n">__readfsdword</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>  <span class="c1">// FS:[0x18]</span>
<span class="n">x64</span><span class="o">:</span> <span class="n">TEB</span><span class="o">*</span> <span class="n">threadEnvBlock</span> <span class="o">=</span> <span class="p">(</span><span class="n">TEB</span><span class="o">*</span><span class="p">)</span><span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>  <span class="c1">// GS:[0x30]</span>
</pre></table></code></div></div><h3 id="accessing-teb-in-windbg"><span class="me-2">Accessing TEB in Windbg:</span><a href="#accessing-teb-in-windbg" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dt nt!_TEB @$teb
</pre></table></code></div></div><h4 id="inspecting-peb-pointer-offset-via-teb-in-windbg-32-bit"><span class="me-2">Inspecting PEB Pointer Offset via TEB in windbg: 32-bit</span><a href="#inspecting-peb-pointer-offset-via-teb-in-windbg-32-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/TEB_32_bit.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/TEB_32_bit.png" alt="TEB_32_bit" width="600" loading="lazy"></a></p><h4 id="inspecting--peb-pointer-offset-via-teb-in-windbg-64-bit"><span class="me-2">Inspecting PEB Pointer Offset via TEB in windbg: 64-bit</span><a href="#inspecting--peb-pointer-offset-via-teb-in-windbg-64-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/TEB_64_bit.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/TEB_64_bit.png" alt="TEB_64_bit" width="600" loading="lazy"></a></p><h3 id="locating-the-the-peb-process-environment-block"><span class="me-2"><strong>Locating the the PEB (Process Environment Block)</strong></span><a href="#locating-the-the-peb-process-environment-block" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The <strong>Process Environment Block (PEB)</strong> is a vital internal structure in Windows that stores comprehensive information about a process at runtime. It acts as a centralized repository containing critical data such as loaded modules (DLLs and EXEs), process heap pointers, command-line arguments, environment variables, and startup information.</p><p>Beyond configuration data, the PEB also includes flags for <strong>debugging detection</strong> (e.g., BeingDebugged), memory protections like <strong>ASLR/DEP</strong>, and various integrity checks that help manage and secure the process. Due to its rich information, the PEB becomes an attractive target for <strong>security researchers, malware analysts, and shellcode developers</strong>, enabling tasks like stealthy debugging detection, process hollowing, in-memory module enumeration, and advanced forensics.Accessing the PEB directly allows one to enumerate loaded modules without invoking high-level Windows APIs, offering a stealthier and more low-level view of the process.</p><blockquote><p><strong>Note:</strong> We will explore the PEB’s <code class="language-plaintext highlighter-rouge">Ldr</code> field and the internal structure <code class="language-plaintext highlighter-rouge">PEB_LDR_DATA</code> in more detail shortly.</p></blockquote><h3 id="architectural-differences-in-peb-pointer-location"><span class="me-2">Architectural Differences in PEB Pointer Location</span><a href="#architectural-differences-in-peb-pointer-location" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As shown in the memory dumps above, the Process Environment Block (PEB) pointer has distinct locations across architectures:</p><ul><li><strong>32-bit Windows:</strong> Accessed via <code class="language-plaintext highlighter-rouge">fs:[0x30]</code> (TEB+0x30)<li><strong>64-bit Windows:</strong> Accessed via <code class="language-plaintext highlighter-rouge">gs:[0x60]</code> (TEB+0x60)</ul><p>The shift from <code class="language-plaintext highlighter-rouge">0x30</code> to <code class="language-plaintext highlighter-rouge">0x60</code> reflects 64-bit memory addressing fundamentals:</p><ol><li><p><strong>8-byte pointers require larger offsets:</strong><br /> Note the high/low split in 64-bit addresses, such as <code class="language-plaintext highlighter-rouge">0x00000087'6506b000</code>.</p><li><p><strong>Structure alignment expands:</strong><br /> This maintains performance with wider registers.</p><li><p><strong>Segment registers switch:</strong><br /> From <code class="language-plaintext highlighter-rouge">FS</code> (32-bit) to <code class="language-plaintext highlighter-rouge">GS</code> (64-bit).</p></ol><h4 id="accessing-the-peb-pointer-in-32-bit-and-64-bit-windows-programtically"><span class="me-2">Accessing the PEB Pointer in 32-bit and 64-bit Windows programtically</span><a href="#accessing-the-peb-pointer-in-32-bit-and-64-bit-windows-programtically" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">// Via TEB structure</span>
<span class="n">PEB</span><span class="o">*</span> <span class="n">procEnvBlock</span> <span class="o">=</span> <span class="n">threadEnvBlock</span><span class="o">-&gt;</span><span class="n">ProcessEnvironmentBlock</span><span class="p">;</span>
<span class="c1">// Direct FS segment access</span>
<span class="n">PEB</span><span class="o">*</span> <span class="n">procEnvBlock</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEB</span><span class="o">*</span><span class="p">)</span><span class="n">__readfsdword</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>  <span class="c1">// FS:[0x30]for 32 bit system</span>
<span class="c1">// Direct GS segment access</span>
<span class="n">PEB</span><span class="o">*</span> <span class="n">procEnvBlock</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEB</span><span class="o">*</span><span class="p">)</span><span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>  <span class="c1">// GS:[0x60]for 64 bit system</span>
</pre></table></code></div></div><h4 id="inspecting-peb-structure-in-windbg-32-bit"><span class="me-2">Inspecting PEB structure in windbg: 32-bit</span><a href="#inspecting-peb-structure-in-windbg-32-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dt nt!_PEB poi(@$teb+0x30)  ; for 32-bit
</pre></table></code></div></div><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/PEB_32_bit.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/PEB_32_bit.png" alt="PEB_32_bit" width="600" loading="lazy"></a></p><h4 id="inspecting-peb-structure-in-windbg-64-bit"><span class="me-2">Inspecting PEB structure in windbg: 64-bit</span><a href="#inspecting-peb-structure-in-windbg-64-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dt nt!_PEB poi(@$teb+0x60)  ; for 64-bit
</pre></table></code></div></div><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/PEB_64_bit.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/PEB_64_bit.png" alt="PEB_64_bit" width="600" loading="lazy"></a></p><hr /><h2 id="accessing-peb_ldr_data-navigating-through-peb-to-module-lists"><span class="me-2">Accessing PEB_LDR_DATA: Navigating Through PEB to Module Lists</span><a href="#accessing-peb_ldr_data-navigating-through-peb-to-module-lists" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When a process starts, Windows internally needs a way to keep track of all the modules (DLLs and EXEs) it loads into memory. This management is handled by the <code class="language-plaintext highlighter-rouge">_PEB_LDR_DATA</code> structure, which is pointed to by the Ldr field inside the PEB.</p><p><code class="language-plaintext highlighter-rouge">_PEB_LDR_DATA</code> maintains three separate doubly linked lists that organize module information in different ways depending on what aspect of loading or memory layout you care about:</p><ul><li><p><strong>InLoadOrderModuleList</strong><br /> Tracks modules in the order they were loaded into the process.</p><li><p><strong>InMemoryOrderModuleList</strong><br /> Tracks modules based on their memory layout within the process.</p><li><p><strong>InInitializationOrderModuleList</strong><br /> Tracks modules in the order they were called during initialization.</p></ul><p>These lists provide a comprehensive view of the modules loaded in a process, making them essential for tasks like debugging, manual module enumeration, and low-level process analysis.</p><h4 id="inspecting-peb_ldr_data-in-windbg-32-bit"><span class="me-2">Inspecting PEB_LDR_DATA in windbg: 32-bit:</span><a href="#inspecting-peb_ldr_data-in-windbg-32-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre># Get PEB_LDR_DATA from TEB-&gt;PEB-&gt;Ldr
dt nt!_PEB_LDR_DATA poi(poi(@$teb+0x30)+0x0c)

# Alternative using LDR address directly
dt nt!_PEB_LDR_DATA 0x77d04340  #(replace with actual Ldr address from your dump)
</pre></table></code></div></div><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/PEB_LDR_DATA_32_bit.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/PEB_LDR_DATA_32_bit.png" alt="PEB_LDR_DATA_32_bit" width="700" loading="lazy"></a></p><h4 id="inspecting-peb_ldr_data-in-windbg-64-bit"><span class="me-2">Inspecting PEB_LDR_DATA in windbg: 64-bit:</span><a href="#inspecting-peb_ldr_data-in-windbg-64-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre># Get PEB_LDR_DATA from TEB-&gt;PEB-&gt;Ldr
dt nt!_PEB_LDR_DATA poi(poi(@$teb+0x60)+0x18)

# Alternative using explicit LDR address
dt nt!_PEB_LDR_DATA 0x00007ffa`f410d8c0  # (replace with your Ldr address)
</pre></table></code></div></div><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/PEB_LDR_DATA_64_bit.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/PEB_LDR_DATA_64_bit.png" alt="PEB_LDR_DATA_64_bit" width="800" loading="lazy"></a></p><h3 id="key-offset-differences"><span class="me-2">Key Offset Differences:</span><a href="#key-offset-differences" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><strong>Ldr</strong>:<ul><li>Offset <code class="language-plaintext highlighter-rouge">+0x018</code> in 64-bit<li>Offset <code class="language-plaintext highlighter-rouge">+0x00c</code> in 32-bit</ul></ul><h3 id="understanding-module-initialization-order-in-windows"><span class="me-2">Understanding Module Initialization Order in Windows</span><a href="#understanding-module-initialization-order-in-windows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The InInitializationOrderModuleList within the _PEB_LDR_DATA structure provides crucial insight into how Windows loads and initializes modules (DLLs) in a process. This list reveals the exact sequence in which each module’s DllMain function was executed - often different from the load order.</p><h3 id="core-concepts"><span class="me-2">Core Concepts</span><a href="#core-concepts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="1-the-list_entry-structure"><span class="me-2">1. The LIST_ENTRY Structure</span><a href="#1-the-list_entry-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>At the core of Windows’ internal module management lies the lightweight and efficient <strong>LIST_ENTRY</strong> structure. It provides a <strong>doubly-linked</strong> list mechanism that allows for quick insertion, removal, and traversal of elements. Rather than reinventing complex data structures for different module lists, Windows standardizes around <strong>LIST_ENTRY</strong>, ensuring consistency and speed.</p><h4 id="_list_entry-structure-looks-like-this"><span class="me-2">_LIST_ENTRY structure looks like this:</span><a href="#_list_entry-structure-looks-like-this" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_LIST_ENTRY</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">_LIST_ENTRY</span><span class="o">*</span> <span class="n">Flink</span><span class="p">;</span>  <span class="c1">// Pointer to the next entry</span>
  <span class="k">struct</span> <span class="n">_LIST_ENTRY</span><span class="o">*</span> <span class="n">Blink</span><span class="p">;</span>  <span class="c1">// Pointer to the previous entry</span>
<span class="p">}</span> <span class="n">LIST_ENTRY</span><span class="p">,</span> <span class="o">*</span><span class="n">PLIST_ENTRY</span><span class="p">;</span>
</pre></table></code></div></div><ul><li><strong>Flink</strong> points to the next entry in the list.<li><strong>Blink</strong> Blink points to the previous entry in the list.</ul><blockquote><p><strong>Key takeaway:</strong> LIST_ENTRY is purely the linking mechanism — it doesn’t store module information itself.</p></blockquote><h4 id="access-_list_entry-in-windbg--32-bit"><span class="me-2">Access _LIST_ENTRY in Windbg : 32-bit</span><a href="#access-_list_entry-in-windbg--32-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre># Method 1: Full chain from TEB
dt nt!_LIST_ENTRY poi(poi(poi(@$teb+0x30)+0x0c)+0x01c)  # InInitializationOrderModuleList

# Method 2: Direct PEB_LDR_DATA address (replace 0x77e74340)
dt nt!_LIST_ENTRY 0x77d04340+0x01c  # InInitializationOrderModuleList


# Walk the module list (32-bit):
!list -x "dt nt!_LDR_DATA_TABLE_ENTRY @$extret" poi(poi(poi(@$teb+0x30)+0x0c)+0x0c)
</pre></table></code></div></div><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/LIST_ENTRY_32_BIT.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/LIST_ENTRY_32_BIT.png" alt="_LIST_ENTRY_32_BIT" width="700" loading="lazy"></a></p><h4 id="access-_list_entry-in-windbg--64-bit"><span class="me-2">Access _LIST_ENTRY in Windbg : 64-bit</span><a href="#access-_list_entry-in-windbg--64-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre># Method 1: Full chain from TEB
dt nt!_LIST_ENTRY poi(poi(poi(@$teb+0x60)+0x18)+0x030)  # InInitializationOrderModuleList

# Method 2: Direct PEB_LDR_DATA address (replace  0x0000027e`07e34120)
dt nt!_LIST_ENTRY 0x0000027e`07e34120+0x30  # InInitializationOrderModuleList


# Walk the module list (64-bit):
!list -x "dt nt!_LDR_DATA_TABLE_ENTRY @$extret" poi(poi(poi(@$teb+0x60)+0x18)+0x10)
</pre></table></code></div></div><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/LIST_ENTRY_64_BIT.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/LIST_ENTRY_64_BIT.png" alt="_LIST_ENTRY_64_BIT" width="900" loading="lazy"></a></p><h4 id="2-the-_ldr_data_table_entry-structure--wrapping-list_entry-with-module-details"><span class="me-2">2. The _LDR_DATA_TABLE_ENTRY Structure : Wrapping LIST_ENTRY with Module Details</span><a href="#2-the-_ldr_data_table_entry-structure--wrapping-list_entry-with-module-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>While <code class="language-plaintext highlighter-rouge">LIST_ENTRY</code> handles linking, it doesn’t know anything about <strong>what</strong> it’s linking.<br /> That’s where <code class="language-plaintext highlighter-rouge">_LDR_DATA_TABLE_ENTRY</code> comes in — it wraps a module’s important metadata around embedded <code class="language-plaintext highlighter-rouge">LIST_ENTRY</code> fields.</p><p>The <code class="language-plaintext highlighter-rouge">_LDR_DATA_TABLE_ENTRY</code> structure represents <strong>one loaded module</strong> (DLL or EXE) and stores key properties such as:</p><ul><li>Base address (<code class="language-plaintext highlighter-rouge">DllBase</code>)<li>Entry point (<code class="language-plaintext highlighter-rouge">EntryPoint</code>)<li>Image size (<code class="language-plaintext highlighter-rouge">SizeOfImage</code>)<li>Full and base DLL names (<code class="language-plaintext highlighter-rouge">FullDllName</code>, <code class="language-plaintext highlighter-rouge">BaseDllName</code>)</ul><p>What makes this design elegant is that each <code class="language-plaintext highlighter-rouge">_LDR_DATA_TABLE_ENTRY</code> embeds three <code class="language-plaintext highlighter-rouge">LIST_ENTRY</code> fields inside it : InLoadOrderLinks, InMemoryOrderLinks, and InInitializationOrderLinks. These embedded links allow a single module to simultaneously exist in multiple module lists, ordered by different criteria.</p><h4 id="ldr_data_table_entry-structure-looks-like-this"><span class="me-2">LDR_DATA_TABLE_ENTRY structure looks like this::</span><a href="#ldr_data_table_entry-structure-looks-like-this" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_LDR_DATA_TABLE_ENTRY</span> <span class="p">{</span>
  <span class="n">LIST_ENTRY</span> <span class="n">InLoadOrderLinks</span><span class="p">;</span>
  <span class="n">LIST_ENTRY</span> <span class="n">InMemoryOrderLinks</span><span class="p">;</span>
  <span class="n">LIST_ENTRY</span> <span class="n">InInitializationOrderLinks</span><span class="p">;</span>
  <span class="n">PVOID</span> <span class="n">DllBase</span><span class="p">;</span>
  <span class="n">PVOID</span> <span class="n">EntryPoint</span><span class="p">;</span>
  <span class="n">ULONG</span> <span class="n">SizeOfImage</span><span class="p">;</span>
  <span class="n">UNICODE_STRING</span> <span class="n">FullDllName</span><span class="p">;</span>
  <span class="n">UNICODE_STRING</span> <span class="n">BaseDllName</span><span class="p">;</span>
  <span class="c1">// ...more fields</span>
<span class="p">}</span> <span class="n">LDR_DATA_TABLE_ENTRY</span><span class="p">,</span> <span class="o">*</span><span class="n">PLDR_DATA_TABLE_ENTRY</span><span class="p">;</span>
</pre></table></code></div></div><h3 id="_list_entry-to-ldr_data_table_entry-conversion--the-containing_record-macro"><span class="me-2">_LIST_ENTRY to LDR_DATA_TABLE_ENTRY Conversion : The CONTAINING_RECORD Macro</span><a href="#_list_entry-to-ldr_data_table_entry-conversion--the-containing_record-macro" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Windows provides the <code class="language-plaintext highlighter-rouge">CONTAINING_RECORD</code> macro to convert a <code class="language-plaintext highlighter-rouge">LIST_ENTRY</code> pointer back to its parent structure:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="cp">#define CONTAINING_RECORD(address, type, field) \
  ((type *)((PCHAR)(address) - (ULONG_PTR)(&amp;((type *)0)-&gt;field)))
</span></pre></table></code></div></div><p>For initialization order traversal, it is used as follows:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PLDR_DATA_TABLE_ENTRY</span> <span class="n">moduleEntry</span> <span class="o">=</span> <span class="n">CONTAINING_RECORD</span><span class="p">(</span>
  <span class="n">listEntry</span><span class="p">,</span>                     <span class="c1">// Current LIST_ENTRY pointer</span>
  <span class="n">LDR_DATA_TABLE_ENTRY</span><span class="p">,</span>          <span class="c1">// Parent structure type</span>
  <span class="n">InInitializationOrderLinks</span>     <span class="c1">// The embedded LIST_ENTRY field</span>
<span class="p">);</span>
</pre></table></code></div></div><h4 id="inspecting-ldr_data_table_entry-in-windbg-32-bit"><span class="me-2">Inspecting LDR_DATA_TABLE_ENTRY in windbg: 32-bit</span><a href="#inspecting-ldr_data_table_entry-in-windbg-32-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dt ntdll!_LDR_DATA_TABLE_ENTRY (poi(poi(poi(@$teb+0x30)+0x0c)+0x1c)-0x10)
</pre></table></code></div></div><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/LDR_DATA_TABLE_ENTRY_32_BIT.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/LDR_DATA_TABLE_ENTRY_32_BIT.png" alt="LDR_DATA_TABLE_ENTRY_32_BIT" width="700" loading="lazy"></a></p><h4 id="inspecting-ldr_data_table_entry-in-windbg-64-bit"><span class="me-2">Inspecting LDR_DATA_TABLE_ENTRY in windbg: 64-bit</span><a href="#inspecting-ldr_data_table_entry-in-windbg-64-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dt ntdll!_LDR_DATA_TABLE_ENTRY (poi(poi(poi(@$teb+0x60)+0x18)+0x30)-0x20)
</pre></table></code></div></div><p><a href="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/LDR_DATA_TABLE_ENTRY_64_BIT.png" class="popup img-link shimmer"><img src="/assets/img/posts/2025-04-24-manually-implementing-getmodulehandle-via-peb/LDR_DATA_TABLE_ENTRY_64_BIT.png" alt="LDR_DATA_TABLE_ENTRY_64_BIT" width="700" loading="lazy"></a></p><h2 id="heres-the-full-code-to-manually-implement-getmodulehandle-programtically"><span class="me-2">Here’s the full code to manually implement GetModuleHandle programtically:</span><a href="#heres-the-full-code-to-manually-implement-getmodulehandle-programtically" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
</pre><td class="rouge-code"><pre>
<span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tchar.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="c1"> // for _tscanf</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_UNICODE_STRING</span> <span class="p">{</span>
	<span class="n">USHORT</span> <span class="n">Length</span><span class="p">;</span>
	<span class="n">USHORT</span> <span class="n">MaximumLength</span><span class="p">;</span>
	<span class="n">PWSTR</span>  <span class="n">Buffer</span><span class="p">;</span>
<span class="p">}</span> <span class="n">UNICODE_STRING</span><span class="p">,</span> <span class="o">*</span> <span class="n">PUNICODE_STRING</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_PEB_LDR_DATA</span> <span class="p">{</span>
	<span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span>
	<span class="n">BOOLEAN</span> <span class="n">Initialized</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">SsHandle</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InLoadOrderModuleList</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InMemoryOrderModuleList</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InInitializationOrderModuleList</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PEB_LDR_DATA</span><span class="p">,</span> <span class="o">*</span> <span class="n">PPEB_LDR_DATA</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_LDR_DATA_TABLE_ENTRY</span> <span class="p">{</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InLoadOrderLinks</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InMemoryOrderLinks</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InInitializationOrderLinks</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">DllBase</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">EntryPoint</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">SizeOfImage</span><span class="p">;</span>
	<span class="n">UNICODE_STRING</span> <span class="n">FullDllName</span><span class="p">;</span>
	<span class="n">UNICODE_STRING</span> <span class="n">BaseDllName</span><span class="p">;</span>
	<span class="c1">// (other fields omitted)</span>
<span class="p">}</span> <span class="n">LDR_DATA_TABLE_ENTRY</span><span class="p">,</span> <span class="o">*</span> <span class="n">PLDR_DATA_TABLE_ENTRY</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_PEB</span> <span class="p">{</span>
	<span class="n">BYTE</span> <span class="n">Reserved1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">BYTE</span> <span class="n">BeingDebugged</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="n">Reserved2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">PVOID</span> <span class="n">Reserved3</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">PPEB_LDR_DATA</span> <span class="n">Ldr</span><span class="p">;</span>
	<span class="c1">// (other fields omitted)</span>
<span class="p">}</span> <span class="n">PEB</span><span class="p">,</span> <span class="o">*</span> <span class="n">PPEB</span><span class="p">;</span>

<span class="c1">//stolen from https://gist.github.com/okumura/7173625</span>
<span class="c1">// Get PEB pointer</span>
<span class="n">LPVOID</span> <span class="nf">GetPEB</span><span class="p">()</span> <span class="p">{</span>
<span class="cp">#if defined(_WIN64)
</span>	<span class="k">return</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>  <span class="c1">// GS:[0x60] for x64</span>
<span class="cp">#else
</span>	<span class="k">return</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">__readfsdword</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>  <span class="c1">// FS:[0x30] for x86</span>
<span class="cp">#endif
</span><span class="p">}</span>

<span class="c1">// Case-insensitive wide string comparison</span>
<span class="kt">int</span> <span class="nf">_wcsicmp_impl</span><span class="p">(</span><span class="n">LPCWSTR</span> <span class="n">str1</span><span class="p">,</span> <span class="n">LPCWSTR</span> <span class="n">str2</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">WCHAR</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">c1</span> <span class="o">=</span> <span class="o">*</span><span class="n">str1</span><span class="o">++</span><span class="p">;</span>
		<span class="n">c2</span> <span class="o">=</span> <span class="o">*</span><span class="n">str2</span><span class="o">++</span><span class="p">;</span>
		<span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">c1</span> <span class="o">&gt;=</span> <span class="sc">'A'</span> <span class="o">&amp;&amp;</span> <span class="n">c1</span> <span class="o">&lt;=</span> <span class="sc">'Z'</span><span class="p">)</span> <span class="o">?</span> <span class="n">c1</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">c1</span><span class="p">;</span>
		<span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2</span> <span class="o">&gt;=</span> <span class="sc">'A'</span> <span class="o">&amp;&amp;</span> <span class="n">c2</span> <span class="o">&lt;=</span> <span class="sc">'Z'</span><span class="p">)</span> <span class="o">?</span> <span class="n">c2</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">c2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">c1</span> <span class="o">&amp;&amp;</span> <span class="n">c1</span> <span class="o">==</span> <span class="n">c2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Find module base address by name</span>
<span class="n">PVOID</span> <span class="nf">GetModuleBase</span><span class="p">(</span><span class="n">LPCWSTR</span> <span class="n">moduleName</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">PPEB</span> <span class="n">peb</span> <span class="o">=</span> <span class="p">(</span><span class="n">PPEB</span><span class="p">)</span><span class="n">GetPEB</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peb</span> <span class="o">||</span> <span class="o">!</span><span class="n">peb</span><span class="o">-&gt;</span><span class="n">Ldr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PLIST_ENTRY</span> <span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peb</span><span class="o">-&gt;</span><span class="n">Ldr</span><span class="o">-&gt;</span><span class="n">InLoadOrderModuleList</span><span class="p">;</span>
	<span class="n">PLIST_ENTRY</span> <span class="n">current</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">Flink</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">current</span> <span class="o">!=</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PLDR_DATA_TABLE_ENTRY</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">CONTAINING_RECORD</span><span class="p">(</span>
			<span class="n">current</span><span class="p">,</span>
			<span class="n">LDR_DATA_TABLE_ENTRY</span><span class="p">,</span>
			<span class="n">InLoadOrderLinks</span>
		<span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">BaseDllName</span><span class="p">.</span><span class="n">Buffer</span> <span class="o">&amp;&amp;</span>
			<span class="n">_wcsicmp_impl</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">BaseDllName</span><span class="p">.</span><span class="n">Buffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">Flink</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">TCHAR</span> <span class="n">dllName</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="n">_tprintf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Enter DLL name (example: kernel32.dll): "</span><span class="p">));</span>
	<span class="n">fgetws</span><span class="p">(</span><span class="n">dllName</span><span class="p">,</span> <span class="n">_countof</span><span class="p">(</span><span class="n">dllName</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>

	<span class="c1">// Remove trailing newline if it exists</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">_tcslen</span><span class="p">(</span><span class="n">dllName</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dllName</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">_T</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dllName</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="sc">'\0'</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PVOID</span> <span class="n">baseAddress</span> <span class="o">=</span> <span class="n">GetModuleBase</span><span class="p">(</span><span class="n">dllName</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baseAddress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_tprintf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"%s base address: 0x%p</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">dllName</span><span class="p">,</span> <span class="n">baseAddress</span><span class="p">);</span>

		<span class="c1">// Verify using GetModuleHandle</span>
		<span class="n">HMODULE</span> <span class="n">hModule</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">dllName</span><span class="p">);</span>
		<span class="n">_tprintf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"GetModuleHandle result: 0x%p</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">hModule</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">hModule</span> <span class="o">==</span> <span class="n">baseAddress</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_tprintf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Verification successful!</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">_tprintf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Warning: Address mismatch!</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">_tprintf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Failed to find %s</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">dllName</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><h2 id="conlcusion-"><span class="me-2">Conlcusion :</span><a href="#conlcusion-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Understanding how Windows internally tracks loaded modules using structures like <strong>_PEB</strong>, <strong>_PEB_LDR_DATA</strong>, and <strong>_LDR_DATA_TABLE_ENTRY</strong> opens the door to low-level techniques that bypass standard APIs. By manually traversing the loader’s linked lists, we can locate the base addresses of DLLs without relying on functions like <strong>GetModuleHandle</strong>, offering both stealth and flexibility. In this post, we built a minimal but powerful example that retrieves any loaded module’s base address directly through the PEB, showing how elegant and reliable direct memory inspection can be. Whether for malware analysis, red teaming, or building custom loaders, mastering these internal mechanisms is a valuable skill for any low-level Windows developer or security researcher.</p><h2 id="key-considerations"><span class="me-2">Key Considerations</span><a href="#key-considerations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>Offset Variations:</strong> Offsets may differ across Windows versions.<li><strong>Unicode Handling:</strong> Module names are case-insensitive Unicode strings.<li><strong>List Termination:</strong> Always check for circular list completion to avoid infinite loops.<li><strong>Memory Protection:</strong> Some fields in the structures may be read-protected.</ul><h2 id="why-this-matters"><span class="me-2">Why This Matters</span><a href="#why-this-matters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>Deep Understanding:</strong> Learn how Windows manages modules.<li><strong>Shellcode Development:</strong> Essential for position-independent code.<li><strong>Anti-Analysis:</strong> Bypass API hooks and detection mechanisms.<li><strong>Debugging Skills:</strong> Better understand process memory layout.</ul><h2 id="common-pitfalls"><span class="me-2">Common Pitfalls</span><a href="#common-pitfalls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><strong>Structure Offsets:</strong> May change between Windows versions.<li><strong>Unicode Handling:</strong> Module names are case-insensitive Unicode.<li><strong>List Termination:</strong> Circular list - check for return to head.<li><strong>x86 vs x64:</strong> Different register usage (FS vs GS).</ul><h2 id="further-exploration"><span class="me-2">Further Exploration</span><a href="#further-exploration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Explore the Export Address Table (EAT).<li>Study the PE file format in depth.<li>Experiment with different Windows versions.</ul><p><strong>References:</strong></p><ol><li><a href="https://cocomelonc.github.io/malware/2023/04/08/malware-av-evasion-15.html">Bypassing AV with direct syscalls and PEB walking - cocomelonc</a><li><a href="https://mohamed-fakroud.gitbook.io/red-teamings-dojo/windows-internals/peb">Windows Internals - Red Teaming’s Dojo by Mohamed Fakroud</a><li><a href="https://print3m.github.io/blog/x64-winapi-shellcoding">x64 WinAPI Shellcoding by print3m</a><li><a href="https://github.com/Faran-17/Windows-Internals/blob/main/Processes%20and%20Jobs/Processes/PEB%20-%20Part%201.md#what-is-peb">Windows Internals - PEB Overview by Faran-17</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/windows-internals/">Windows Internals</a>, <a href="/categories/red-team/">Red Team</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/peb/" class="post-tag no-text-decoration" >PEB</a> <a href="/tags/getmodulehandle/" class="post-tag no-text-decoration" >GetModuleHandle</a> <a href="/tags/windows-api/" class="post-tag no-text-decoration" >Windows API</a> <a href="/tags/manual-mapping/" class="post-tag no-text-decoration" >Manual Mapping</a> <a href="/tags/red-teaming/" class="post-tag no-text-decoration" >Red Teaming</a> <a href="/tags/malware-development/" class="post-tag no-text-decoration" >Malware Development</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Understanding%20the%20mechanishm%20of%20GetModuleHandle%20from%20Scratch%20via%20PEB%20from%20a%20shellcoders%20perspective%20-%20OffSecEchoes&url=https%3A%2F%2Fs4vtrx.github.io%2F%2Fposts%2Fmanually-implementing-getmodulehandle-via-peb%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Understanding%20the%20mechanishm%20of%20GetModuleHandle%20from%20Scratch%20via%20PEB%20from%20a%20shellcoders%20perspective%20-%20OffSecEchoes&u=https%3A%2F%2Fs4vtrx.github.io%2F%2Fposts%2Fmanually-implementing-getmodulehandle-via-peb%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fs4vtrx.github.io%2F%2Fposts%2Fmanually-implementing-getmodulehandle-via-peb%2F&text=Understanding%20the%20mechanishm%20of%20GetModuleHandle%20from%20Scratch%20via%20PEB%20from%20a%20shellcoders%20perspective%20-%20OffSecEchoes" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/manually-implementing-getmodulehandle-via-peb/">Understanding the mechanishm of GetModuleHandle from Scratch via PEB from a shellcoders perspective</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/getmodulehandle/">GetModuleHandle</a> <a class="post-tag btn btn-outline-primary" href="/tags/malware-development/">Malware Development</a> <a class="post-tag btn btn-outline-primary" href="/tags/manual-mapping/">Manual Mapping</a> <a class="post-tag btn btn-outline-primary" href="/tags/peb/">PEB</a> <a class="post-tag btn btn-outline-primary" href="/tags/red-teaming/">Red Teaming</a> <a class="post-tag btn btn-outline-primary" href="/tags/windows-api/">Windows API</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"><div class="btn btn-outline-primary disabled" aria-label="Older"><p>-</p></div><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://x.com/Arinjoy20">Arinjoy</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/getmodulehandle/">GetModuleHandle</a> <a class="post-tag btn btn-outline-primary" href="/tags/malware-development/">Malware Development</a> <a class="post-tag btn btn-outline-primary" href="/tags/manual-mapping/">Manual Mapping</a> <a class="post-tag btn btn-outline-primary" href="/tags/peb/">PEB</a> <a class="post-tag btn btn-outline-primary" href="/tags/red-teaming/">Red Teaming</a> <a class="post-tag btn btn-outline-primary" href="/tags/windows-api/">Windows API</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
